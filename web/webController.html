<!DOCTYPE html>
<html>
<head>
    <title>Adeept AWR Web Controller</title>
    <script src="roslib.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="main-container">

    <h1 class="main-header">Adeept AWR Controller</h1>

    <p class="main-status" id="statusIndicator">Connecting to rosbridge...</p>

    <div class="camera-container">
        <button class="camera-button" onclick="cameraToggle()">Toggle Video Feed</button>
        <img id="camera" class="camera-image">
    </div>

    <div class="servo-container">
        <input class="angle-selector" id="angle_slider" type="range" min="150" max="350" value="300">
        <button class="look-up" onclick="servoCommand(0)">Up</button>
        <button class="look-down" onclick="servoCommand(1)">Down</button>
    </div>

    <div class="drive-container">
        <button class="drive-forward" id="w" onmousedown="driveCommand('forward', 'press')" onmouseup="driveCommand('forward', 'release')">w</button>
        <button class="drive-back" id="s" onmousedown="driveCommand('back', 'press')" onmouseup="driveCommand('back', 'release')">s</button>
        <button class="drive-left" id="a" onmousedown="driveCommand('left', 'press')" onmouseup="driveCommand('left', 'release')">a</button>
        <button class="drive-right" id="d" onmousedown="driveCommand('right', 'press')" onmouseup="driveCommand('right', 'release')">d</button>    
    </div>
    
    <div class="lights-container">
        <input type="color" onchange="changeColorCommand(this.value)"/>
    </div>

    <script>
        var ros = new ROSLIB.Ros();

        var statusIndicator = document.getElementById("statusIndicator")
        ros.on('error', function(error) {
            statusIndicator.innerHTML = "Error in the backend";
            statusIndicator.style.color = "#FF0000"
            console.log(error);
        });

        ros.on('connection', function() {
            statusIndicator.innerHTML = "Connected";
            statusIndicator.style.color = "#00D600"
            console.log('Connection made!');
        });

        ros.on('close', function() {
            statusIndicator.innerHTML = "Connection closed";
            statusIndicator.style.color = ""
            console.log('Connection closed.');
        });

        ros.connect('ws://192.168.2.1:9090');

        var pressedDirections = {
            forward: false,
            back: false,
            left: false,
            right: false
        };

        function driveCommand(direction, action) {
            var topic = new ROSLIB.Topic({
                ros : ros,
                name : '/drive_directions',
                messageType : 'geometry_msgs/msg/Twist'
            });

            if (action == "press")
            {
                pressedDirections[direction] = true;
            }
            else
            {
                pressedDirections[direction] = false;
            }

            var msg = new ROSLIB.Message({
                    linear : {
                    x : 0,
                    y : 0,
                    z : 0
                    },
                    angular : {
                    x : 0,
                    y : 0,
                    z : 0
                    }
                });
        
            if (pressedDirections.forward)
            {
                msg.linear.x = 0.30695

                if (pressedDirections.left)
                {
                    msg.angular.z = 2.923
                }
                else if (pressedDirections.right)
                {
                    msg.angular.z = -2.923
                }
            }
            else if (pressedDirections.back)
            {
                msg.linear.x = -0.30695

                if (pressedDirections.left)
                {
                    msg.angular.z = -2.923
                }
                else if (pressedDirections.right)
                {
                    msg.angular.z = 2.923
                }
            }
            else if (pressedDirections.left)
            {
                msg.angular.z = 2.1925
            }
            else if (pressedDirections.right)
            {
                msg.angular.z = -2.1925
            }
            
            topic.publish(msg);
        }

        function servoCommand(direction)
        {
            var webController = new ROSLIB.Service({
                ros : ros,
                name : '/web_controller',
                serviceType : 'adeept_awr_interfaces/srv/WebCommand'
            });

            var request = new ROSLIB.ServiceRequest({
                type: 5,
                value: direction
            });

            webController.callService(request, function(result) {
                console.log("servo result");
            });

            var angleSlider = document.getElementById("angle_slider");
            if (direction == 0)
            {
                angleSlider.value = Number(angleSlider.value) - 20
            }
            else
            {
                angleSlider.value = Number(angleSlider.value) + 20
            }
        }

        const angleSlider = document.getElementById("angle_slider");
        angleSlider.addEventListener("change", servoTotalCommand);
        function servoTotalCommand()
        {
            var webController = new ROSLIB.Service({
                ros : ros,
                name : '/web_controller',
                serviceType : 'adeept_awr_interfaces/srv/WebCommand'
            });

            var angleSlider = document.getElementById("angle_slider");
            var request = new ROSLIB.ServiceRequest({
                type: 4,
                value: Number(angle_slider.value)
            });

            webController.callService(request, function(result) {
                console.log("servo result");
            });
        }

        var cameraListener = new ROSLIB.Topic({
            ros : ros,
            name : '/camera_stream',
            messageType : 'adeept_awr_interfaces/msg/CameraFrame'
        });
        var cameraListenerEnabled = false;
        function cameraToggle()
        {
            if (cameraListenerEnabled)
            {
                cameraListener.unsubscribe();
                cameraListenerEnabled = false;
            }
            else
            {
                cameraListener.subscribe(function(message) {
                    var camera = document.getElementById('camera');
                    camera.src = message.base64_data;
                });
                cameraListenerEnabled = true;
            }
        }

        var keyDownFlag = {};
        document.addEventListener('keydown', event => {
            if (!keyDownFlag[event.code])
            {
                switch (event.key) {
                    case 'w':
                        driveCommand('forward', 'press')
                        break;
                    case 's':
                        driveCommand('back', 'press')
                        break;
                    case 'a':
                        driveCommand('left', 'press')
                        break;
                    case 'd':
                        driveCommand('right', 'press')
                        break;
                    default:
                        console.log("none")
                        break;
                }
            }
            keyDownFlag[event.code] = true;
        });

        
        document.addEventListener('keyup', event => {
            switch (event.key) {
                    case 'w':
                        driveCommand('forward', 'release')
                        break;
                    case 's':
                        driveCommand('back', 'release')
                        break;
                    case 'a':
                        driveCommand('left', 'release')
                        break;
                    case 'd':
                        driveCommand('right', 'release')
                        break;
                    default:
                        console.log("none")
                        break;
                }
            keyDownFlag[event.code] = false;
        });

        function changeColorCommand(selectedColor)
        {
            var hexaColorValue = selectedColor.replace(/^#/, '');
            var decColorValue = parseInt(hexaColorValue, 16);
            var r = (decColorValue >> 16) & 255;
            var g = (decColorValue >> 8) & 255;
            var b = decColorValue & 255;

            var ledController = new ROSLIB.Service({
                ros : ros,
                name : '/change_rgb_color',
                serviceType : 'adeept_awr_interfaces/srv/RBG'
            });

            var request = new ROSLIB.ServiceRequest({
                r: r,
                g: g,
                b: b
            });

            ledController.callService(request, function(result) {
                console.log("color changed");
            });
        }

    </script>
</body>
</html>
